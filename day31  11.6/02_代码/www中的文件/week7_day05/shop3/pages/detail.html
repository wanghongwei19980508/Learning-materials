<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <link rel="stylesheet" href="../bootstrap-3.3.7-dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="../css/base.css">
  <link rel="stylesheet" href="../css/detail.css">
</head>
<body>
<h1>我是一个商品详情页面</h1>

<div class="container"></div>

<script src="../js/jquery.min.js"></script>
<script src="../js/tools.js"></script>
<script src="../js/cookie.js"></script>
<script>
  // 1, 获取 url地址栏中的数据对象
  const urlObj = getUrlVal();

  // 定义一个变量,准备存储 商品信息
  let msg;

  // 2, 根据 goods_id 向数据库做数据查询操作
  $.ajax({
    url:'../server/goods_detail.php',
    data:{ goods_id: urlObj.goods_id },
    type:'post',
    dataType:'json',
    // res 是 存储的商品信息
    success:res=>{
      // 给 msg 变量赋值商品信息
      msg = res;


      let str = `
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">商品详细信息</h3>
        </div>
        <div class="panel-body">
          <div class="media">
            <div class="media-left">
              <a href="#">
                <img class="media-object" src="${res.goods_small_logo}" alt="...">
              </a>
            </div>
            <div class="media-body">
              <h4 class="media-heading">${res.goods_name}</h4>
              <p>
                <i class="glyphicon glyphicon-yen"></i>
                <span>${res.goods_price}</span>
              </p>
              <div class="btn-group" role="group" aria-label="...">
                <button type="button" class="btn btn-default">XL</button>
                <button type="button" class="btn btn-default">L</button>
                <button type="button" class="btn btn-default">M</button>
                <button type="button" class="btn btn-default">S</button>
                <button type="button" class="btn btn-default">XS</button>
              </div>
              <p>
                <a href="javascript:;" class="btn btn-warning btn-lg" role="button">立即购买</a>
                <a href="JavaScript:;" name="inCart" class="btn btn-danger btn-lg" role="button">加入购物车</a>
              </p>
            </div>
          </div>
          <ul class="nav nav-tabs">
            <li role="presentation" class="active"><a href="#">商品详细信息</a></li>
            <li role="presentation"><a href="#">商品参数信息</a></li>
            <li role="presentation"><a href="#">相关商品</a></li>
          </ul>
          <div>
              ${res.goods_introduce}
          </div>
        </div>
      </div>
      
      `;
      // 将 str 写入到 div中
      $('.container').html(str);
    
    }
  })

  // 3, 给父级添加点击事件,通过事件委托方式,给加入购物车,添加点击事件
  $('.container').on( 'click' , '[name="inCart"]' , ()=>{
    // 判断 是否已经 登录
    // 获取 cookie 对象
    const cookieObj = myGetCookie();

    if(cookieObj.login === undefined){
      let bool = window.confirm('您还没有登录,点击确定,跳转登录页面');
      if(bool){
        window.location.href = `./login.html?url=${window.location.href}`;
      }
    }else{
      // 已经登录
      // 将 当前 商品数据,添加到 购物车 数据信息中
      /*
         思路:
            1, 购物车是空的,没有购车车
               直接添加商品信息,购买数量是1

            2, 如果有购物车
               看购物车中,是否有当前商品
                   如果有当前商品,购买数量+1
                   如果没有当前商品,添加当前商品,购买数量是1
      */ 

      // 1, 获取 localStorage 中 购物车信息
      // 如果没有 cart 获取的结果是 null
      let cartArr = window.localStorage.getItem('cart');
      console.log(cartArr);

      // 2, 进行判断
      if( cartArr === null ){
        // 当前商品信息,存储在 msg 变量中 以 对象形式存储
        // 现在需要添加 属性 购买数量默认是 1
        msg.num = 1;
        // 再添加一个属性,是购买属性,默认是购买状态
        msg.buy = true;

        // 购物车中,一定需要可以同时存储多条数据信息
        // 因此,数据结构是,数组中存储对象,对象就是每条商品的信息

        // 创建一个数组,数组中,存储一个单元,这个单元,就是当前商品信息
        // 这个数组,就是购物车的数据信息
        const arr = [ msg ];

        // 将数组类型,转化为 json字符串,存储到 localStorage 中 cart 键名中
        window.localStorage.setItem( 'cart' , JSON.stringify(arr) );
     
      }else{
        // 购物车已经存在
        // 判断购物车中,是否有当前商品
        // 判断 购物车中商品的 goods_id  和 当前商品的 goods_id 是不是一样
        // 一样,就是相同商品

        // 如果有数据,存储的是json串,先要还原
        cartArr = JSON.parse(cartArr);

        // 定义一个变量
        let bool = true;
        
        // 循环遍历,cartObj数组,当前使用的是JavaScript语法操作
        cartArr.forEach( (v,k)=>{
          if(v.goods_id === msg.goods_id){
            // 如果,循环的购物车商品v的goods_id,与当前商品msg的goods_id相同
            // 证明是同一个商品,给购物车中存储商品信息的购买数量+1
            v.num++;

            // 如果 商品已经存在
            bool = false;
          }
        })

        // 循环结束, 如果 bool 是false , 证明商品已经存在
        //          如果 book 是true , 证明商品不存在
        if(bool){
          // 新增商品
          // 新增 购买数量属性,是否购买属性
          msg.num = 1;
          msg.buy = true;

          // 当前购物车数据信息数组是 cartAyy
          // 向这个数组,新增单元
          cartArr.push( msg );
        }

        // 将新的数组,存储到 localStorage 中 cart 键名中
        // 新数组,要么是购买数量+1 要么是新增了一个一个商品
        window.localStorage.setItem( 'cart' , JSON.stringify( cartArr ) );



        // 跳转购物车页面
        window.location.href = './cart.html';


      }
    }
  
  

  
  
  } )

  /*  
      js的事件委托
      const oDiv = document.querySelector('.container');
      oDiv.addEventListener( 'click' , e=>{
        if(e.target.getAttribute('name') === 'inCart'){}
      })  
  */


  /*
      使用 localStorage 存储数据
        1, 在 localStorage 中 存储的是一个数组
           数组单元 是 商品 信息--对象形式
           存储时,要转化为json串

        2, 存储时,要先给购物车商品信息,添加属性
           购买属性,buy,默认值是 true
           购买数量,num,默认值是 1

        3, 如果是新增商品信息,一定要将商品信息,存储在数组中
           将数组设定给 localStorage 中 cart 键名存储

        4, 如果 localStorage 中 没有 cart 键名 获取结果是 null
           证明购物车不存在

        5, 如果购物车存在
               获取 商品信息 数组 循环遍历数组
                    如果存储商品信息的 goods_id 和 当前商品信息 good_is 相同
                        证明商品已经存在, 购买数量 num  +1
                    如果没有 发生 goods_id 相同
                        证明商品不存在, 向 数组 新增单元

                将新增的数组,存储到 localStorage 的 cart 中
           
  
  
  
  
  
  */


</script>

</body>
</html>
